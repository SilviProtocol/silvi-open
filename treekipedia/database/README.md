# Treekipedia Database

This directory contains database schemas, migrations, and seed data for the Treekipedia project.

## Current Schema Structure
The definitive current schema is in `current-schema.sql` (with `schema.sql` as a symlink to this file) and has been updated with payment system tables from `payment_schema_update.sql`.

The Treekipedia database consists of five main tables:

1. **species** - Contains all tree species data with separate fields for AI-generated and human-verified content
2. **users** - Tracks user information and total points
3. **contreebution_nfts** - Records of NFTs minted for research contributions
4. **sponsorships** - Tracks payment transactions for species research funding
5. **sponsorship_items** - Records individual species funded through sponsorships

## Table Structure Details

### Species Table

The species table uses a suffix-based field naming convention to differentiate data sources:
- Fields with `_ai` suffix: Content generated by AI (GPT-4o + Perplexity)
- Fields with `_human` suffix: Content verified or provided by human contributors
- Base fields (no suffix): Being phased out in favor of the `_ai` and `_human` suffixed fields

#### Key Species Fields

- `taxon_id` (TEXT) - Primary key, unique identifier for each species
- `species_scientific_name` (VARCHAR) - Scientific name (preferred over legacy `species` field)
- `common_name` (TEXT) - Common names for the species
- Various ecological, morphological, and stewardship fields with `_ai` and `_human` suffixes
- `ipfs_cid` (VARCHAR) - IPFS content identifier for species metadata
- `researched` (BOOLEAN) - Flag indicating whether this species has been researched
- `sponsored` (BOOLEAN) - Flag indicating whether this species has been sponsored
- `sponsored_by` (TEXT) - Wallet address of the sponsor
- `sponsored_at` (TIMESTAMP WITH TIME ZONE) - When the species was sponsored

### Users Table

- `id` (SERIAL) - Primary key
- `wallet_address` (TEXT) - Unique blockchain wallet address
- `display_name` (TEXT) - Optional user-set display name
- `total_points` (INTEGER DEFAULT 0) - Total points accumulated
- `first_contribution_at` (TIMESTAMP WITH TIME ZONE) - When the user first contributed
- `last_contribution_at` (TIMESTAMP WITH TIME ZONE) - When the user last contributed
- `contribution_count` (INTEGER DEFAULT 0) - Number of contributions made
- `created_at` (TIMESTAMP WITH TIME ZONE) - Record creation timestamp
- `updated_at` (TIMESTAMP WITH TIME ZONE) - Record update timestamp

### Contreebution NFTs Table

- `id` (SERIAL) - Primary key
- `global_id` (BIGINT) - Unique sequential ID for NFTs
- `taxon_id` (TEXT) - References species.taxon_id
- `wallet_address` (TEXT) - Wallet address of the owner
- `points` (INTEGER DEFAULT 2) - Points awarded for this contribution
- `ipfs_cid` (TEXT) - IPFS content identifier for NFT metadata
- `transaction_hash` (TEXT) - Blockchain transaction hash
- `metadata` (JSONB) - Additional NFT metadata
- `created_at` (TIMESTAMP WITH TIME ZONE) - Record creation timestamp

### Sponsorships Table

- `id` (SERIAL) - Primary key
- `wallet_address` (TEXT) - Wallet address of the sponsor
- `chain` (TEXT) - Blockchain network used (e.g., base, celo, optimism, arbitrum)
- `transaction_hash` (TEXT UNIQUE) - Unique blockchain transaction hash
- `total_amount` (NUMERIC) - Total USDC amount paid (currently 0.01 USDC for testing, normally 3 USDC per species)
- `payment_timestamp` (TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP) - When the payment was made
- `status` (VARCHAR(50) DEFAULT 'pending') - Payment status (pending, confirmed, failed)
- `created_at` (TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP) - Record creation timestamp
- `updated_at` (TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP) - Record update timestamp

### Sponsorship Items Table

- `id` (SERIAL) - Primary key
- `sponsorship_id` (INTEGER) - References sponsorships.id, with CASCADE deletion
- `taxon_id` (TEXT) - References species.taxon_id
- `amount` (NUMERIC DEFAULT 3) - Amount paid for this species (default 3 USDC, currently 0.01 USDC for testing)
- `research_status` (VARCHAR(50) DEFAULT 'pending') - Status of the research (pending, researching, completed, failed)
- `nft_token_id` (BIGINT) - References contreebution_nfts.global_id
- `ipfs_cid` (TEXT) - IPFS content identifier for NFT metadata
- `created_at` (TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP) - Record creation timestamp
- `updated_at` (TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP) - Record update timestamp

## Constraints and Relationships

The database has several important constraints:

- Primary keys on all table IDs
- Foreign key between `sponsorship_items.sponsorship_id` and `sponsorships.id` (with CASCADE deletion)
- Foreign key between `sponsorship_items.taxon_id` and `species.taxon_id`
- Unique constraint on `sponsorships.transaction_hash`
- Unique constraint on `(sponsorship_id, taxon_id)` pairs in `sponsorship_items`

## Database Functions and Views

### Functions

#### update_user_points()
- **Purpose**: Updates users table when a new NFT is inserted
- **Trigger**: Executes automatically after INSERT on contreebution_nfts
- **Operation**: Adds points, increments contribution_count, and updates timestamps
- **Behavior**: Creates new user record if wallet_address doesn't exist, otherwise updates existing record

#### update_species_sponsorship_status()
- **Purpose**: Updates species table when research is completed for a sponsored species
- **Trigger**: Executes automatically after UPDATE on sponsorship_items
- **Condition**: Only triggers when research_status changes to 'completed'
- **Operation**: Sets sponsored = TRUE, sponsored_by = wallet_address, sponsored_at = payment_timestamp

#### get_sponsorship_status(tx_hash TEXT)
- **Purpose**: Returns detailed status information for a sponsorship by transaction hash
- **Return Type**: TABLE with columns matching sponsorships table + count fields
- **Column Types**: Uses character varying(50) for status field (fixed from previous TEXT type)
- **Operation**: Joins sponsorships with sponsorship_items to get counts

### Views

#### sponsorship_summary
- **Purpose**: Provides a summary view of all sponsorships with species counts
- **Columns**: sponsorship_id, wallet_address, chain, transaction_hash, total_amount, payment_timestamp, payment_status, species_count, completed_count, taxon_ids
- **Calculation**: Counts total species and completed research for each sponsorship
- **Grouping**: Groups by sponsorship fields to provide aggregation

## Status Values Documentation

### Sponsorships Table Status Values
- **pending**: Initial state when sponsorship is created but payment not confirmed
- **confirmed**: Payment has been verified on the blockchain
- **failed**: Payment transaction failed or was rejected

### Sponsorship Items Research Status Values
- **pending**: Research has not started yet
- **researching**: AI research process is in progress
- **completed**: Research completed successfully
- **failed**: Research process failed

## Recent Updates and Fixes

1. **Fixed `get_sponsorship_status` function**: Updated the function signature to use VARCHAR(50) for status field instead of TEXT to match database schema
2. **Added constraints documentation**: Clarified the constraints between tables
3. **Standardized status values**: Documented the valid status values for both tables
4. **Added trigger details**: Explained when and how triggers are executed
5. **Updated USDC amount**: Noted the change to 0.01 USDC for testing (normally 3 USDC)

## Database Migration Scripts

The `/scripts/db/` directory contains migration scripts for schema updates:

- `remove_base_fields_only.sql` - Removes the base fields without migrating data, while keeping the researched flag
- `fix_varchar_fields.sql` - Increases VARCHAR field sizes from 100 to 300
- `schema_update.sql` - Comprehensive schema update combining multiple changes
- `payment_schema_update.sql` - Adds tables and fields for the payment system
- `fix_sponsorship_status_function.sql` - Fixes the get_sponsorship_status function signature

## Connection Information

The database connection is configured through the `DATABASE_URL` environment variable in the root `.env` file:

```
DATABASE_URL=postgres://[username]:[password]@[host]:[port]/treekipedia
```

## Applying Schema Updates

To apply database schema updates:

1. Connect to the database server
2. Run the migration script:
   ```
   psql -U [username] -d treekipedia -f database/[migration_script].sql
   ```

For example, to apply the payment system schema update:
```
psql -U [username] -d treekipedia
\i database/payment_schema_update.sql
```

To fix the get_sponsorship_status function:
```
psql -U [username] -d treekipedia
\i database/fix_sponsorship_status_function.sql
```

Or use the helper script to drop base fields (without migrating data) while preserving the researched flag:
```
cd scripts/db
./drop_base_fields.sh
```