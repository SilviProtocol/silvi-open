<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL to Fuseki Monitor - Treekipedia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/treekipedia-unified.css">
</head>
<body>
    <div class="container">
        <div class="header compact">
            <h1><i class="fas fa-database"></i> PostgreSQL to Fuseki Monitor</h1>
            <p class="lead">Monitor PostgreSQL integration and sync to Apache Jena Fuseki</p>
            <span class="treekipedia-highlight"><i class="fas fa-tree"></i> 50,000+ Tree Species</span>
        </div>

        <!-- Connection Status Alert -->
        <div id="connection-alert" class="alert alert-warning d-none" role="alert">
            <i class="fas fa-exclamation-triangle"></i> <span id="connection-message">Checking connections...</span>
        </div>

        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="info-card text-center">
                    <h5><span id="postgres-status-indicator" class="status-indicator loading"></span>PostgreSQL</h5>
                    <p id="postgres-status-text">Checking...</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-card text-center">
                    <h5><span id="fuseki-status-indicator" class="status-indicator loading"></span>Apache Fuseki</h5>
                    <p id="fuseki-status-text">Checking...</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-card text-center">
                    <h5><i class="fas fa-table"></i> Tables</h5>
                    <div id="table-count" class="h4 text-primary-custom">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-card text-center">
                    <h5><i class="fas fa-project-diagram"></i> RDF Triples</h5>
                    <div id="triple-count" class="h4 text-success">-</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <div class="col-md-8">
                <!-- Tables -->
                <div class="info-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-table"></i> Database Tables</h4>
                        <button class="btn btn-primary btn-sm" onclick="loadTables()"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr><th>Table</th><th>Rows</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="tables-list">
                                <tr><td colspan="3" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sync Results -->
                <div class="info-card">
                    <h4><i class="fas fa-sync-alt"></i> Sync Results</h4>
                    <div id="sync-results-content">
                        <p class="text-muted">No sync operations performed yet.</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Fuseki Operations -->
                <div class="info-card">
                    <h4><i class="fas fa-server"></i> Fuseki Operations</h4>
                    <div id="fuseki-stats" class="mb-3">
                        <div class="loading">Loading Fuseki statistics...</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="syncAllTables()" id="sync-all-btn">
                            <i class="fas fa-rocket"></i> Sync All Tables to Fuseki
                        </button>
                        <button class="btn btn-info" onclick="loadFusekiStats()">
                            <i class="fas fa-chart-bar"></i> Refresh Fuseki Stats
                        </button>
                        <a href="http://167.172.143.162:3030/" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i> Open Fuseki Web UI
                        </a>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Home
                        </a>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="info-card">
                    <h4><i class="fas fa-zap"></i> Quick Actions</h4>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success btn-sm" onclick="testConnections()">
                            <i class="fas fa-heartbeat"></i> Test Connections
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="queryFuseki()">
                            <i class="fas fa-search"></i> Query Fuseki
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="clearFusekiData()">
                            <i class="fas fa-trash"></i> Clear Fuseki Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Modal -->
    <div class="modal fade" id="syncModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sync Table to Fuseki</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Table</label>
                        <select id="sync-table-select" class="form-select">
                            <option value="">Select table...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Batch Size</label>
                        <input type="number" id="batch-size" class="form-control" value="1000" min="100" max="10000">
                        <div class="form-text">Number of records to process at once</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="startSyncOperation()" id="sync-btn">
                        <i class="fas fa-sync-alt"></i> Start Sync
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Modal -->
    <div class="modal fade" id="queryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Query Fuseki</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">SPARQL Query</label>
                        <textarea id="sparql-query" class="form-control" rows="6" placeholder="Enter SPARQL query...">SELECT * WHERE { ?s ?p ?o } LIMIT 10</textarea>
                    </div>
                    <div id="query-results"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="executeSparqlQuery()">
                        <i class="fas fa-play"></i> Execute Query
                    </button>
                    <button class="btn btn-secondary" onclick="loadSampleQueries()">
                        <i class="fas fa-lightbulb"></i> Sample Queries
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Info Modal -->
    <div class="modal fade" id="batchInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle"></i> Batch Processing Info</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="batch-info-content">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Getting table information...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="start-batch-sync" onclick="startBatchSync()" disabled>
                        <i class="fas fa-play"></i> Start Batch Sync
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Progress Modal -->
    <div class="modal fade" id="batchProgressModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cogs"></i> Batch Sync Progress</h5>
                </div>
                <div class="modal-body">
                    <div id="batch-progress-content">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span id="progress-status">Preparing...</span>
                                <span id="progress-percentage">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="batch-details" class="small text-muted"></div>
                        <div id="batch-logs" class="mt-3" style="max-height: 300px; overflow-y: auto;">
                            <!-- Progress logs will be added here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-batch" onclick="cancelBatchSync()">Cancel</button>
                    <button type="button" class="btn btn-success" id="complete-batch" onclick="completeBatchSync()" disabled style="display: none;">
                        <i class="fas fa-check"></i> Complete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allTables = [];
        let systemOnline = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ PostgreSQL to Fuseki Monitor starting...');
            initializeMonitor();
        });

        async function initializeMonitor() {
            try {
                await checkSystemStatus();
                await loadTables();
                await loadFusekiStats();
                
                // Auto-refresh every 30 seconds
                setInterval(checkSystemStatus, 30000);
                
                hideConnectionAlert();
            } catch (error) {
                console.error('Initialization error:', error);
                showConnectionAlert('Failed to initialize monitor', 'danger');
            }
        }

        function showConnectionAlert(message, type = 'warning') {
            const alert = document.getElementById('connection-alert');
            const messageSpan = document.getElementById('connection-message');
            
            alert.className = `alert alert-${type}`;
            alert.classList.remove('d-none');
            messageSpan.textContent = message;
        }

        function hideConnectionAlert() {
            document.getElementById('connection-alert').classList.add('d-none');
        }

        async function checkSystemStatus() {
            try {
                // Check both PostgreSQL and Fuseki status
                const response = await fetch('/api/system-status-fuseki');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const status = await response.json();
                console.log('System status:', status);
                
                // Update PostgreSQL status
                updateStatusIndicator('postgres', status.postgresql?.status || 'error');
                document.getElementById('postgres-status-text').textContent = 
                    status.postgresql?.message || 'Connection failed';
                
                // Update Fuseki status
                updateStatusIndicator('fuseki', status.fuseki?.status || 'error');
                document.getElementById('fuseki-status-text').textContent = 
                    status.fuseki?.message || 'Connection failed';
                
                systemOnline = status.postgresql?.status === 'connected' && status.fuseki?.status === 'online';
                
                if (!systemOnline) {
                    showConnectionAlert('One or more connections failed. Check PostgreSQL and Fuseki servers.', 'danger');
                    disableButtons();
                } else {
                    hideConnectionAlert();
                    enableButtons();
                }
                
            } catch (error) {
                console.error('Status check error:', error);
                updateStatusIndicator('postgres', 'error');
                updateStatusIndicator('fuseki', 'error');
                document.getElementById('postgres-status-text').textContent = 'Check failed';
                document.getElementById('fuseki-status-text').textContent = 'Check failed';
                showConnectionAlert(`System check failed: ${error.message}`, 'danger');
                disableButtons();
            }
        }

        function updateStatusIndicator(system, status) {
            const indicator = document.getElementById(`${system}-status-indicator`);
            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'connected':
                case 'online':
                    indicator.classList.add('online');
                    break;
                case 'error':
                case 'offline':
                    indicator.classList.add('offline');
                    break;
                default:
                    indicator.classList.add('loading');
            }
        }

        function enableButtons() {
            document.getElementById('sync-all-btn').disabled = false;
            document.getElementById('sync-btn').disabled = false;
        }

        function disableButtons() {
            document.getElementById('sync-all-btn').disabled = true;
            document.getElementById('sync-btn').disabled = true;
        }

        async function loadTables() {
            try {
                document.getElementById('tables-list').innerHTML = 
                    '<tr><td colspan="3" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading tables...</td></tr>';
                
                const response = await fetch('/api/postgres-tables');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Tables data:', data);
                
                if (data.success && data.tables) {
                    allTables = data.tables;
                    document.getElementById('table-count').textContent = data.total_tables || 0;
                    
                    const tbody = document.getElementById('tables-list');
                    tbody.innerHTML = data.tables.map(table => {
                        return `
                        <tr class="table-row-clickable">
                            <td>
                                <strong>${table.name}</strong>
                                ${table.name === 'species' ? '<span class="treekipedia-highlight ms-2"><i class="fas fa-tree"></i></span>' : ''}
                            </td>
                            <td>${(table.total_rows || 0).toLocaleString()}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="syncTable('${table.name}')"
                                            ${!systemOnline ? 'disabled' : ''}>
                                        <i class="fas fa-sync-alt"></i> Sync Sample
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="showBatchInfo('${table.name}')"
                                            ${!systemOnline ? 'disabled' : ''}>
                                        <i class="fas fa-info-circle"></i> Batch Info
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('');

                    // Update table select dropdown
                    const select = document.getElementById('sync-table-select');
                    select.innerHTML = '<option value="">Select table...</option>' + 
                        data.tables.map(table => `<option value="${table.name}">${table.name} (${(table.total_rows || 0).toLocaleString()} rows)</option>`).join('');
                } else {
                    throw new Error(data.error || 'Invalid response format');
                }
            } catch (error) {
                console.error('Load tables error:', error);
                document.getElementById('tables-list').innerHTML = 
                    `<tr><td colspan="3" class="text-center error-message">
                        <i class="fas fa-exclamation-triangle"></i> Error loading tables: ${error.message}
                    </td></tr>`;
                document.getElementById('table-count').textContent = '?';
            }
        }

        async function loadFusekiStats() {
            const statsDiv = document.getElementById('fuseki-stats');
            statsDiv.innerHTML = '<div class="loading">Loading Fuseki statistics...</div>';
            
            try {
                const response = await fetch('/fuseki-stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    let html = `
                        <div class="row text-center">
                            <div class="col-6">
                                <h6>Total Triples</h6>
                                <div class="h5 text-primary">${stats.total_triples.toLocaleString()}</div>
                            </div>
                            <div class="col-6">
                                <h6>Entities</h6>
                                <div class="h5 text-success">${stats.total_entities.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                    
                    if (stats.entity_types.length > 0) {
                        html += '<hr><h6>Top Entity Types:</h6><ul class="list-unstyled small">';
                        stats.entity_types.slice(0, 3).forEach(type => {
                            const shortType = type.type.split('/').pop() || type.type;
                            html += `<li><i class="fas fa-circle text-primary me-1"></i> ${shortType}: ${type.count.toLocaleString()}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    statsDiv.innerHTML = html;
                    document.getElementById('triple-count').textContent = stats.total_triples.toLocaleString();
                } else {
                    statsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
                
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">Error loading statistics: ${error.message}</div>`;
            }
        }

        function syncTable(tableName) {
            if (!systemOnline) {
                alert('Cannot sync: System connections failed');
                return;
            }
            
            document.getElementById('sync-table-select').value = tableName;
            const modal = new bootstrap.Modal(document.getElementById('syncModal'));
            modal.show();
        }

        async function startSyncOperation() {
            const tableName = document.getElementById('sync-table-select').value;
            const batchSize = document.getElementById('batch-size').value;
            
            if (!tableName) {
                alert('Please select a table to sync');
                return;
            }
            
            const button = document.getElementById('sync-btn');
            const originalText = button.innerHTML;
            
            try {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                
                const formData = new FormData();
                formData.append('table_name', tableName);
                formData.append('batch_size', batchSize);
                
                // Use the new Fuseki sync endpoint
                const response = await fetch('/postgres-sync-fuseki', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const resultHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle"></i> Sync Successful!</h5>
                            <ul class="mb-0">
                                <li><strong>Table:</strong> ${data.table_name}</li>
                                <li><strong>Records Processed:</strong> ${data.records_processed.toLocaleString()}</li>
                                <li><strong>RDF Triples Generated:</strong> ${data.rdf_triples.toLocaleString()}</li>
                                <li><strong>Upload Success:</strong> ${data.upload_success ? 'Yes' : 'No'}</li>
                            </ul>
                        </div>
                    `;
                    
                    document.getElementById('sync-results-content').innerHTML = resultHTML;
                    
                    // Hide modal and refresh stats
                    bootstrap.Modal.getInstance(document.getElementById('syncModal')).hide();
                    loadFusekiStats();
                } else {
                    alert(`Sync Failed: ${data.error}`);
                }
                
            } catch (error) {
                alert(`Sync Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function syncAllTables() {
            if (!systemOnline) {
                alert('Cannot sync: System connections failed');
                return;
            }
            
            if (!confirm('This will sync ALL tables from PostgreSQL to Fuseki. This may take a long time. Continue?')) {
                return;
            }
            
            const button = document.getElementById('sync-all-btn');
            const originalText = button.innerHTML;
            
            try {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing All Tables...';
                
                const response = await fetch('/postgres-full-sync-fuseki', {
                    method: 'POST',
                    body: new FormData()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let resultHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle"></i> Full Sync Completed!</h5>
                            <ul>
                                <li><strong>Tables Processed:</strong> ${data.tables_processed}</li>
                                <li><strong>Total Records:</strong> ${data.total_records.toLocaleString()}</li>
                                <li><strong>Total Triples:</strong> ${data.total_triples.toLocaleString()}</li>
                            </ul>
                        </div>
                        
                        <h6>Table Results:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>Table</th><th>Records</th><th>Triples</th><th>Status</th></tr></thead>
                                <tbody>
                    `;
                    
                    data.table_results.forEach(result => {
                        const status = result.success ? '<span class="text-success">‚úÖ Success</span>' : '<span class="text-danger">‚ùå Failed</span>';
                        resultHTML += `
                            <tr>
                                <td>${result.table_name}</td>
                                <td>${result.records_processed.toLocaleString()}</td>
                                <td>${result.triples_generated.toLocaleString()}</td>
                                <td>${status}</td>
                            </tr>
                        `;
                    });
                    
                    resultHTML += '</tbody></table></div>';
                    
                    if (data.errors.length > 0) {
                        resultHTML += '<h6>Errors:</h6><ul>';
                        data.errors.forEach(error => {
                            resultHTML += `<li class="text-danger">${error}</li>`;
                        });
                        resultHTML += '</ul>';
                    }
                    
                    document.getElementById('sync-results-content').innerHTML = resultHTML;
                    loadFusekiStats();
                } else {
                    alert(`Full Sync Failed: ${data.error}`);
                }
                
            } catch (error) {
                alert(`Full Sync Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function testConnections() {
            try {
                const response = await fetch('/api/system-status-fuseki');
                const status = await response.json();
                
                const postgresStatus = status.postgresql?.status === 'connected' ? '‚úÖ Connected' : '‚ùå Failed';
                const fusekiStatus = status.fuseki?.status === 'online' ? '‚úÖ Online' : '‚ùå Offline';
                
                alert(`Connection Test Results:\n\nPostgreSQL: ${postgresStatus}\nApache Fuseki: ${fusekiStatus}`);
            } catch (error) {
                alert(`Connection test failed: ${error.message}`);
            }
        }

        function queryFuseki() {
            const modal = new bootstrap.Modal(document.getElementById('queryModal'));
            modal.show();
        }

        async function executeSparqlQuery() {
            const query = document.getElementById('sparql-query').value;
            const resultsDiv = document.getElementById('query-results');
            
            if (!query.trim()) {
                alert('Please enter a SPARQL query');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Executing query...</div>';
            
            try {
                const formData = new FormData();
                formData.append('query', query);
                
                const response = await fetch('/fuseki-test-query', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results.results.bindings;
                    let html = `<h6>Query Results (${results.length} rows)</h6>`;
                    
                    if (results.length > 0) {
                        html += '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>';
                        
                        // Get column headers
                        const headers = Object.keys(results[0]);
                        headers.forEach(header => {
                            html += `<th>${header}</th>`;
                        });
                        html += '</tr></thead><tbody>';
                        
                        // Add rows (limit to first 20)
                        results.slice(0, 20).forEach(row => {
                            html += '<tr>';
                            headers.forEach(header => {
                                const value = row[header]?.value || '';
                                const shortValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                                html += `<td title="${value}">${shortValue}</td>`;
                            });
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></div>';
                        
                        if (results.length > 20) {
                            html += `<p class="small text-muted">Showing first 20 of ${results.length} results</p>`;
                        }
                    } else {
                        html += '<p class="text-muted">No results found</p>';
                    }
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Query Failed: ${data.error}</div>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Query Error: ${error.message}</div>`;
            }
        }

        function loadSampleQueries() {
            const queries = [
                'SELECT * WHERE { ?s ?p ?o } LIMIT 10',
                'SELECT (COUNT(*) as ?count) WHERE { ?s ?p ?o }',
                'SELECT ?type (COUNT(?s) as ?count) WHERE { ?s a ?type } GROUP BY ?type ORDER BY DESC(?count)',
                'SELECT * WHERE { ?s a <http://treekipedia.org/ontology/Species> } LIMIT 10',
                'SELECT * WHERE { ?s <http://treekipedia.org/property/species> ?species } LIMIT 10'
            ];
            
            const query = queries[Math.floor(Math.random() * queries.length)];
            document.getElementById('sparql-query').value = query;
        }

        async function clearFusekiData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data from Fuseki. This action cannot be undone. Are you sure?')) {
                return;
            }
            
            if (!confirm('This is your final warning. All RDF data in Fuseki will be permanently deleted. Continue?')) {
                return;
            }
            
            try {
                // Execute a DELETE query to clear all data
                const deleteQuery = 'DROP ALL';
                
                const formData = new FormData();
                formData.append('query', deleteQuery);
                
                const response = await fetch('/fuseki-test-query', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('‚úÖ Fuseki data cleared successfully');
                    loadFusekiStats();
                } else {
                    alert('‚ùå Failed to clear Fuseki data');
                }
                
            } catch (error) {
                alert(`Error clearing data: ${error.message}`);
            }
        }

        // Batch Processing Functions
        let currentBatchInfo = null;
        let batchSyncRunning = false;

        async function showBatchInfo(tableName) {
            const modal = new bootstrap.Modal(document.getElementById('batchInfoModal'));
            modal.show();

            try {
                const formData = new FormData();
                formData.append('table_name', tableName);

                const response = await fetch('/postgres-table-info', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentBatchInfo = data;

                    const approxRows = data.approx_rows || 'Unknown';
                    const estimatedBatches = data.estimated_batches || 'Unknown';
                    const batchSize = data.recommended_batch_size;

                    const content = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-table"></i> Table: ${tableName}</h6>
                            <ul class="mb-0">
                                <li><strong>Approximate Rows:</strong> ${typeof approxRows === 'number' ? approxRows.toLocaleString() : approxRows}</li>
                                <li><strong>Primary Key:</strong> ${data.primary_key || 'None detected'}</li>
                                <li><strong>Batch Size:</strong> ${batchSize.toLocaleString()} records per batch</li>
                                <li><strong>Estimated Batches:</strong> ${typeof estimatedBatches === 'number' ? estimatedBatches.toLocaleString() : estimatedBatches}</li>
                            </ul>
                        </div>

                        <div class="mt-3">
                            <h6>How Batch Sync Works:</h6>
                            <ol class="small">
                                <li>Processes ${batchSize.toLocaleString()} records at a time</li>
                                <li>Uses primary key ordering to prevent duplicates</li>
                                <li>Shows real-time progress</li>
                                <li>Can be resumed if interrupted</li>
                            </ol>
                        </div>

                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Important Notes:</h6>
                            <ul class="mb-0">
                                <li>This will sync the entire table to Fuseki</li>
                                <li>Large tables may take considerable time</li>
                                <li>Existing data with same IDs will be updated</li>
                                <li>You can cancel at any time</li>
                            </ul>
                        </div>
                    `;

                    document.getElementById('batch-info-content').innerHTML = content;
                    document.getElementById('start-batch-sync').disabled = false;
                } else {
                    document.getElementById('batch-info-content').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('batch-info-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error loading table info: ${error.message}
                    </div>
                `;
            }
        }

        async function startBatchSync() {
            if (!currentBatchInfo || batchSyncRunning) return;

            // Hide info modal and show progress modal
            bootstrap.Modal.getInstance(document.getElementById('batchInfoModal')).hide();
            const progressModal = new bootstrap.Modal(document.getElementById('batchProgressModal'));
            progressModal.show();

            batchSyncRunning = true;
            let currentOffset = 0;
            let batchNumber = 1;
            let totalProcessed = 0;
            let hasMore = true;

            const tableName = currentBatchInfo.table_name;
            const batchSize = currentBatchInfo.recommended_batch_size;
            const estimatedBatches = currentBatchInfo.estimated_batches || 1;

            // Initialize progress display
            updateProgress(0, `Starting batch sync for ${tableName}...`, '');

            try {
                while (hasMore && batchSyncRunning) {
                    const progress = estimatedBatches > 0 ? (batchNumber / estimatedBatches) * 100 : 0;
                    updateProgress(
                        Math.min(progress, 95), // Never show 100% until truly complete
                        `Processing batch ${batchNumber}${estimatedBatches > 0 ? ` of ~${estimatedBatches}` : ''}...`,
                        `Offset: ${currentOffset.toLocaleString()}, Processed: ${totalProcessed.toLocaleString()}`
                    );

                    const formData = new FormData();
                    formData.append('table_name', tableName);
                    formData.append('offset', currentOffset);
                    formData.append('batch_size', batchSize);

                    const response = await fetch('/postgres-sync-batch', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        totalProcessed += result.records_processed;
                        hasMore = result.has_more;
                        currentOffset = result.next_offset || (currentOffset + batchSize);

                        addLogEntry(
                            `‚úÖ Batch ${batchNumber} completed: ${result.records_processed} records, ${result.rdf_triples} triples generated`,
                            'success'
                        );

                        if (!hasMore) {
                            updateProgress(100, 'Batch sync completed!', `Total processed: ${totalProcessed.toLocaleString()}`);
                            addLogEntry(`üéâ All batches completed! Total: ${totalProcessed.toLocaleString()} records`, 'success');

                            document.getElementById('cancel-batch').style.display = 'none';
                            document.getElementById('complete-batch').style.display = 'inline-block';
                            document.getElementById('complete-batch').disabled = false;

                            // Refresh Fuseki stats
                            loadFusekiStats();
                            break;
                        }
                    } else {
                        addLogEntry(`‚ùå Batch ${batchNumber} failed: ${result.error}`, 'error');
                        updateProgress(progress, `Batch ${batchNumber} failed`, result.error);
                        break;
                    }

                    batchNumber++;

                    // Small delay to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            } catch (error) {
                addLogEntry(`üí• Sync error: ${error.message}`, 'error');
                updateProgress(0, 'Sync failed', error.message);
            }

            batchSyncRunning = false;
        }

        function updateProgress(percentage, status, details) {
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-percentage').textContent = `${Math.round(percentage)}%`;
            document.getElementById('progress-status').textContent = status;
            document.getElementById('batch-details').textContent = details;
        }

        function addLogEntry(message, type = 'info') {
            const logsDiv = document.getElementById('batch-logs');
            const timestamp = new Date().toLocaleTimeString();
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';

            const logEntry = document.createElement('div');
            logEntry.className = `alert ${alertClass} py-2 mb-1 small`;
            logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;

            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function cancelBatchSync() {
            batchSyncRunning = false;
            addLogEntry('üõë Batch sync cancelled by user', 'warning');
            updateProgress(0, 'Cancelled', 'Batch sync was cancelled');
        }

        function completeBatchSync() {
            bootstrap.Modal.getInstance(document.getElementById('batchProgressModal')).hide();
            // Reset state
            currentBatchInfo = null;
            batchSyncRunning = false;
        }
    </script>
</body>
</html>