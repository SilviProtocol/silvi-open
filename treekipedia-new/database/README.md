# Treekipedia Database

This directory contains database schemas, migrations, and seed data for the Treekipedia project.

## Current Schema Structure
The definitive current schema is in `current-schema.sql` (with `schema.sql` as a symlink to this file) and has been updated with payment system tables from `payment_schema_update.sql`.

The Treekipedia database consists of five main tables:

1. **species** - Contains all tree species data with separate fields for AI-generated and human-verified content
2. **users** - Tracks user information and total points
3. **contreebution_nfts** - Records of NFTs minted for research contributions
4. **sponsorships** - Tracks payment transactions for species research funding
5. **sponsorship_items** - Records individual species funded through sponsorships

### Species Table

The species table uses a suffix-based field naming convention to differentiate data sources:
- Fields with `_ai` suffix: Content generated by AI (GPT-4o + Perplexity)
- Fields with `_human` suffix: Content verified or provided by human contributors
- Base fields (no suffix): Being phased out in favor of the `_ai` and `_human` suffixed fields

#### Key Species Fields

- `taxon_id` (TEXT) - Primary key, unique identifier for each species
- `species_scientific_name` (VARCHAR) - Scientific name (preferred over legacy `species` field)
- `common_name` (TEXT) - Common names for the species
- Various ecological, morphological, and stewardship fields with `_ai` and `_human` suffixes
- `ipfs_cid` (VARCHAR) - IPFS content identifier for species metadata
- `researched` (BOOLEAN) - Flag indicating whether this species has been researched
- `sponsored` (BOOLEAN) - Flag indicating whether this species has been sponsored
- `sponsored_by` (TEXT) - Wallet address of the sponsor
- `sponsored_at` (TIMESTAMP WITH TIME ZONE) - When the species was sponsored

### Users Table

- `wallet_address` (TEXT) - Unique blockchain wallet address
- `display_name` (TEXT) - Optional user-set display name
- `total_points` (INTEGER) - Total points accumulated
- `contribution_count` (INTEGER) - Number of contributions made

### Contreebution NFTs Table

- `global_id` (BIGINT) - Unique sequential ID for NFTs
- `taxon_id` (TEXT) - References species.taxon_id
- `wallet_address` (TEXT) - Wallet address of the owner
- `ipfs_cid` (TEXT) - IPFS content identifier for NFT metadata
- `transaction_hash` (TEXT) - Blockchain transaction hash
- `metadata` (JSONB) - Additional NFT metadata

### Sponsorships Table

- `id` (SERIAL) - Primary key
- `wallet_address` (TEXT) - Wallet address of the sponsor
- `chain` (TEXT) - Blockchain network used (e.g., base, celo, optimism, arbitrum)
- `transaction_hash` (TEXT) - Unique blockchain transaction hash
- `total_amount` (NUMERIC) - Total USDC amount paid (3 USDC per species)
- `payment_timestamp` (TIMESTAMP WITH TIME ZONE) - When the payment was made
- `status` (VARCHAR) - Payment status (pending, confirmed)
- `created_at` (TIMESTAMP WITH TIME ZONE) - Record creation timestamp
- `updated_at` (TIMESTAMP WITH TIME ZONE) - Record update timestamp

### Sponsorship Items Table

- `id` (SERIAL) - Primary key
- `sponsorship_id` (INTEGER) - References sponsorships.id
- `taxon_id` (TEXT) - References species.taxon_id
- `amount` (NUMERIC) - Amount paid for this species (default 3 USDC)
- `research_status` (VARCHAR) - Status of the research (pending, researching, completed, failed)
- `nft_token_id` (BIGINT) - References contreebution_nfts.global_id
- `ipfs_cid` (TEXT) - IPFS content identifier for NFT metadata
- `created_at` (TIMESTAMP WITH TIME ZONE) - Record creation timestamp
- `updated_at` (TIMESTAMP WITH TIME ZONE) - Record update timestamp

## Database Functions and Views

### Functions

#### update_user_points()
- Updates users table when a new NFT is inserted
- Adds points, increments contribution_count, and updates timestamps

#### update_species_sponsorship_status()
- Updates species sponsorship status when research is completed
- Sets sponsored flag, sponsored_by, and sponsored_at fields

#### get_sponsorship_status(tx_hash TEXT)
- Returns detailed status information for a sponsorship by transaction hash
- Includes counts of total species and completed species

### Views

#### sponsorship_summary
- Provides a summary view of all sponsorships with species counts
- Includes wallet_address, chain, transaction_hash, total_amount, etc.
- Aggregates counts of species and completed research for each sponsorship

## Recent Schema Changes

1. **Migrated to _ai and _human fields**: All content fields now use _ai and _human suffixes to differentiate between AI-generated and human-verified content
2. **Removed legacy base fields**: Original fields without suffixes have been migrated to _ai fields and removed from the schema
3. **Maintained researched flag**: The boolean `researched` flag is still used to track which species have been researched
4. **Field size increases**: VARCHAR fields have been increased from 100 to 300 characters to accommodate longer data
5. **Added payment system tables**: New sponsorships and sponsorship_items tables to track research funding
6. **Added species sponsorship fields**: New sponsored, sponsored_by, and sponsored_at fields for the species table

## Database Migration Scripts

The `/scripts/db/` directory contains migration scripts for schema updates:

- `remove_base_fields_only.sql` - Removes the base fields without migrating data, while keeping the researched flag
- `fix_varchar_fields.sql` - Increases VARCHAR field sizes from 100 to 300
- `schema_update.sql` - Comprehensive schema update combining multiple changes
- `payment_schema_update.sql` - Adds tables and fields for the payment system

## Connection Information

The database connection is configured through the `DATABASE_URL` environment variable in the root `.env` file:

```
DATABASE_URL=postgres://[username]:[password]@[host]:[port]/treekipedia
```

## Applying Schema Updates

To apply database schema updates:

1. Connect to the database server
2. Run the migration script:
   ```
   psql -U [username] -d treekipedia -f database/[migration_script].sql
   ```

For example, to apply the payment system schema update:
```
psql -U [username] -d treekipedia
\i database/payment_schema_update.sql
```

Or use the helper script to drop base fields (without migrating data) while preserving the researched flag:
```
cd scripts/db
./drop_base_fields.sh
```